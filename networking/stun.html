<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>STUN - My Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../css/general-2459343d.css">
        <link rel="stylesheet" href="../css/chrome-ae938929.css">
        <link rel="stylesheet" href="../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex-91648d44.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc-a4fa5267.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">My Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="stun-session-traversal-utilities-for-nat"><a class="header" href="#stun-session-traversal-utilities-for-nat">STUN (Session Traversal Utilities for NAT)</a></h1>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>STUN is a standardized network protocol that allows clients behind NAT (Network Address Translation) to discover their public IP address and the type of NAT they are behind. This information is crucial for establishing peer-to-peer connections in applications like VoIP, video conferencing, and WebRTC.</p>
<h2 id="the-nat-problem"><a class="header" href="#the-nat-problem">The NAT Problem</a></h2>
<h3 id="why-stun-is-needed"><a class="header" href="#why-stun-is-needed">Why STUN is Needed</a></h3>
<pre><code>Private Network              NAT Router            Internet
                             (Public IP)
+------------------+         +---------+         +----------------+
| PC1: 192.168.1.10|  ---&gt;  | Router  |  ---&gt;  | Other peer     |
| PC2: 192.168.1.11|         | External IP:     | wants to       |
| PC3: 192.168.1.12|         | 203.0.113.5      | connect to you |
+------------------+         +---------+         +----------------+

Problem: How does external peer know your public IP and port?
Solution: STUN server tells you!
</code></pre>
<h3 id="without-stun"><a class="header" href="#without-stun">Without STUN</a></h3>
<pre><code>Peer A (behind NAT) wants to connect to Peer B

Peer A knows only: 192.168.1.10 (private IP)
Peer B needs: 203.0.113.5:54321 (public IP:port)

Peer A can't tell Peer B how to reach it L
</code></pre>
<h3 id="with-stun"><a class="header" href="#with-stun">With STUN</a></h3>
<pre><code>Peer A queries STUN server
STUN server responds: "I see you as 203.0.113.5:54321"
Peer A tells Peer B: "Connect to 203.0.113.5:54321"
Peer B connects successfully 
</code></pre>
<h2 id="stun-architecture"><a class="header" href="#stun-architecture">STUN Architecture</a></h2>
<pre><code>Client                    STUN Server               Peer
(Behind NAT)              (Public IP)
  |                            |                      |
  | STUN Binding Request       |                      |
  |---------------------------&gt;|                      |
  |                            |                      |
  | STUN Binding Response      |                      |
  |&lt;---------------------------|                      |
  | (Your public IP:Port)      |                      |
  |                            |                      |
  | Send public IP:Port        |                      |
  |--------------------------------------------------&gt;|
  |                            |                      |
  |        Direct connection established              |
  |&lt;-------------------------------------------------&gt;|
</code></pre>
<h2 id="stun-message-format"><a class="header" href="#stun-message-format">STUN Message Format</a></h2>
<h3 id="message-structure"><a class="header" href="#message-structure">Message Structure</a></h3>
<pre><code> 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|0 0|     STUN Message Type     |         Message Length        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         Magic Cookie                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
|                     Transaction ID (96 bits)                  |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         Attributes                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</code></pre>
<h3 id="header-fields"><a class="header" href="#header-fields">Header Fields</a></h3>
<ol>
<li>
<p><strong>Message Type</strong> (16 bits):</p>
<ul>
<li>Class: Request (0x00), Success Response (0x01), Error Response (0x11)</li>
<li>Method: Binding (0x001)</li>
</ul>
</li>
<li>
<p><strong>Message Length</strong> (16 bits):</p>
<ul>
<li>Length of attributes (excluding 20-byte header)</li>
</ul>
</li>
<li>
<p><strong>Magic Cookie</strong> (32 bits):</p>
<ul>
<li>Fixed value: 0x2112A442</li>
<li>Helps distinguish STUN from other protocols</li>
</ul>
</li>
<li>
<p><strong>Transaction ID</strong> (96 bits):</p>
<ul>
<li>Unique identifier for matching requests/responses</li>
</ul>
</li>
</ol>
<h3 id="message-types"><a class="header" href="#message-types">Message Types</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Type</th><th>Value</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><strong>Binding Request</strong></td><td>0x0001</td><td>Request public IP/port</td></tr>
<tr><td><strong>Binding Response</strong></td><td>0x0101</td><td>Success response with address</td></tr>
<tr><td><strong>Binding Error</strong></td><td>0x0111</td><td>Error response</td></tr>
</tbody>
</table>
</div>
<h2 id="stun-attributes"><a class="header" href="#stun-attributes">STUN Attributes</a></h2>
<h3 id="common-attributes"><a class="header" href="#common-attributes">Common Attributes</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Attribute</th><th>Type</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><strong>MAPPED-ADDRESS</strong></td><td>0x0001</td><td>Reflexive transport address (legacy)</td></tr>
<tr><td><strong>XOR-MAPPED-ADDRESS</strong></td><td>0x0020</td><td>XORed reflexive address (preferred)</td></tr>
<tr><td><strong>USERNAME</strong></td><td>0x0006</td><td>Username for authentication</td></tr>
<tr><td><strong>MESSAGE-INTEGRITY</strong></td><td>0x0008</td><td>HMAC-SHA1 hash</td></tr>
<tr><td><strong>ERROR-CODE</strong></td><td>0x0009</td><td>Error code and reason</td></tr>
<tr><td><strong>UNKNOWN-ATTRIBUTES</strong></td><td>0x000A</td><td>Unknown required attributes</td></tr>
<tr><td><strong>REALM</strong></td><td>0x0014</td><td>Realm for authentication</td></tr>
<tr><td><strong>NONCE</strong></td><td>0x0015</td><td>Nonce for digest authentication</td></tr>
<tr><td><strong>SOFTWARE</strong></td><td>0x8022</td><td>Software version</td></tr>
<tr><td><strong>FINGERPRINT</strong></td><td>0x8028</td><td>CRC-32 of message</td></tr>
</tbody>
</table>
</div>
<h3 id="xor-mapped-address-format"><a class="header" href="#xor-mapped-address-format">XOR-MAPPED-ADDRESS Format</a></h3>
<pre><code> 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|0 0 0 0 0 0 0 0|    Family     |         X-Port                |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                X-Address (Variable)                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

Family: 0x01 (IPv4), 0x02 (IPv6)
X-Port: Port XORed with most significant 16 bits of magic cookie
X-Address: IP address XORed with magic cookie (and transaction ID for IPv6)
</code></pre>
<p><strong>Why XOR?</strong></p>
<ul>
<li>Prevents middle boxes from modifying the address</li>
<li>Some NAT devices inspect and modify IP addresses in packets</li>
</ul>
<h2 id="stun-transaction-example"><a class="header" href="#stun-transaction-example">STUN Transaction Example</a></h2>
<h3 id="binding-request"><a class="header" href="#binding-request">Binding Request</a></h3>
<pre><code>Client → STUN Server (UDP port 3478)

Message Type: Binding Request (0x0001)
Message Length: 0
Magic Cookie: 0x2112A442
Transaction ID: 0xB7E7A701BC34D686FA87DFAE

No attributes in basic request
</code></pre>
<p><strong>Hexadecimal:</strong></p>
<pre><code>00 01 00 00 21 12 A4 42
B7 E7 A7 01 BC 34 D6 86
FA 87 DF AE
</code></pre>
<h3 id="binding-response"><a class="header" href="#binding-response">Binding Response</a></h3>
<pre><code>STUN Server → Client

Message Type: Binding Response (0x0101)
Message Length: 12 (length of attributes)
Magic Cookie: 0x2112A442
Transaction ID: 0xB7E7A701BC34D686FA87DFAE (same as request)

Attributes:
  XOR-MAPPED-ADDRESS:
    Family: IPv4 (0x01)
    Port: 54321 (XORed)
    IP: 203.0.113.5 (XORed)
</code></pre>
<p><strong>Information extracted:</strong></p>
<pre><code>Your public IP address: 203.0.113.5
Your public port: 54321
NAT binding created: 192.168.1.10:5000 ↔ 203.0.113.5:54321
</code></pre>
<h2 id="nat-types-discovered-by-stun"><a class="header" href="#nat-types-discovered-by-stun">NAT Types Discovered by STUN</a></h2>
<h3 id="1-full-cone-nat"><a class="header" href="#1-full-cone-nat">1. Full Cone NAT</a></h3>
<pre><code>Internal: 192.168.1.10:5000

NAT creates mapping:
  192.168.1.10:5000 ↔ 203.0.113.5:6000

Any external host can send to 203.0.113.5:6000
  → Forwarded to 192.168.1.10:5000

Best for P2P (easy to traverse)
</code></pre>
<h3 id="2-restricted-cone-nat"><a class="header" href="#2-restricted-cone-nat">2. Restricted Cone NAT</a></h3>
<pre><code>Internal: 192.168.1.10:5000

NAT creates mapping:
  192.168.1.10:5000 ↔ 203.0.113.5:6000

External host 1.2.3.4 can send to 203.0.113.5:6000
  ONLY IF 192.168.1.10:5000 previously sent to 1.2.3.4

Moderate difficulty to traverse
</code></pre>
<h3 id="3-port-restricted-cone-nat"><a class="header" href="#3-port-restricted-cone-nat">3. Port Restricted Cone NAT</a></h3>
<pre><code>Internal: 192.168.1.10:5000

NAT creates mapping:
  192.168.1.10:5000 ↔ 203.0.113.5:6000

External host 1.2.3.4:7000 can send to 203.0.113.5:6000
  ONLY IF 192.168.1.10:5000 previously sent to 1.2.3.4:7000

More difficult to traverse
</code></pre>
<h3 id="4-symmetric-nat"><a class="header" href="#4-symmetric-nat">4. Symmetric NAT</a></h3>
<pre><code>Internal: 192.168.1.10:5000

NAT creates different mappings per destination:
  To host A: 192.168.1.10:5000 ↔ 203.0.113.5:6000
  To host B: 192.168.1.10:5000 ↔ 203.0.113.5:6001
  To host C: 192.168.1.10:5000 ↔ 203.0.113.5:6002

Difficult to traverse (may need TURN relay)
</code></pre>
<h2 id="stun-usage-in-ice"><a class="header" href="#stun-usage-in-ice">STUN Usage in ICE</a></h2>
<p><strong>ICE (Interactive Connectivity Establishment)</strong> uses STUN:</p>
<h3 id="ice-candidate-gathering"><a class="header" href="#ice-candidate-gathering">ICE Candidate Gathering</a></h3>
<pre><code>1. Host Candidate:
   Local IP: 192.168.1.10:5000

2. Server Reflexive Candidate (from STUN):
   Public IP: 203.0.113.5:6000

3. Relayed Candidate (from TURN):
   Relay IP: 198.51.100.1:7000

Try connections in order:
  1. Direct (host to host)
  2. Through NAT (server reflexive)
  3. Through relay (last resort)
</code></pre>
<h3 id="webrtc-connection-flow"><a class="header" href="#webrtc-connection-flow">WebRTC Connection Flow</a></h3>
<pre><code>Peer A                    STUN Server              Peer B
  |                            |                      |
  | Get my public IP           |                      |
  |---------------------------&gt;|                      |
  |                            |                      |
  | 203.0.113.5:6000           |                      |
  |&lt;---------------------------|                      |
  |                            |                      |
  | Exchange candidates via signaling server          |
  |&lt;-------------------------------------------------&gt;|
  |                            |                      |
  | Try connection             |                      |
  |&lt;-------------------------------------------------&gt;|
  | Connectivity check (STUN)  |                      |
  |&lt;-------------------------------------------------&gt;|
  |                            |                      |
  | Connection established     |                      |
  |&lt;=================================================&gt;|
</code></pre>
<h2 id="stun-authentication"><a class="header" href="#stun-authentication">STUN Authentication</a></h2>
<h3 id="short-term-credentials"><a class="header" href="#short-term-credentials">Short-Term Credentials</a></h3>
<pre><code>Request:
  USERNAME: "alice:bob"
  MESSAGE-INTEGRITY: HMAC-SHA1(message, password)

Server validates:
  1. Check username exists
  2. Compute HMAC with stored password
  3. Compare with MESSAGE-INTEGRITY
  4. Accept or reject
</code></pre>
<h3 id="long-term-credentials"><a class="header" href="#long-term-credentials">Long-Term Credentials</a></h3>
<pre><code>Request 1 (no credentials):
  Binding Request

Response 1:
  Error 401 Unauthorized
  REALM: "example.com"
  NONCE: "random-nonce-12345"

Request 2 (with credentials):
  USERNAME: "alice"
  REALM: "example.com"
  NONCE: "random-nonce-12345"
  MESSAGE-INTEGRITY: HMAC-SHA1(message, MD5(username:realm:password))

Response 2:
  Binding Success Response
  XOR-MAPPED-ADDRESS: ...
</code></pre>
<h2 id="stun-client-implementation"><a class="header" href="#stun-client-implementation">STUN Client Implementation</a></h2>
<h3 id="python-example"><a class="header" href="#python-example">Python Example</a></h3>
<pre><code class="language-python">import socket
import struct
import hashlib
import hmac

STUN_SERVER = "stun.l.google.com"
STUN_PORT = 19302
MAGIC_COOKIE = 0x2112A442

def create_stun_binding_request():
    # Message type: Binding Request (0x0001)
    msg_type = 0x0001

    # Message length: 0 (no attributes)
    msg_length = 0

    # Transaction ID: 96 random bits
    transaction_id = os.urandom(12)

    # Pack header
    header = struct.pack(
        '!HHI',
        msg_type,
        msg_length,
        MAGIC_COOKIE
    ) + transaction_id

    return header, transaction_id

def parse_stun_response(data, transaction_id):
    # Parse header
    msg_type, msg_length, magic_cookie = struct.unpack('!HHI', data[:8])
    recv_transaction_id = data[8:20]

    # Verify transaction ID
    if recv_transaction_id != transaction_id:
        raise Exception("Transaction ID mismatch")

    # Parse attributes
    offset = 20
    while offset &lt; len(data):
        attr_type, attr_length = struct.unpack('!HH', data[offset:offset+4])
        offset += 4

        if attr_type == 0x0020:  # XOR-MAPPED-ADDRESS
            # Parse XOR-MAPPED-ADDRESS
            family = data[offset + 1]
            x_port = struct.unpack('!H', data[offset+2:offset+4])[0]
            x_ip = struct.unpack('!I', data[offset+4:offset+8])[0]

            # Un-XOR
            port = x_port ^ (MAGIC_COOKIE &gt;&gt; 16)
            ip = x_ip ^ MAGIC_COOKIE
            ip_addr = socket.inet_ntoa(struct.pack('!I', ip))

            return ip_addr, port

        offset += attr_length

    return None, None

def get_public_ip_port():
    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    sock.settimeout(3)

    try:
        # Create and send binding request
        request, transaction_id = create_stun_binding_request()
        sock.sendto(request, (STUN_SERVER, STUN_PORT))

        # Receive response
        data, addr = sock.recvfrom(1024)

        # Parse response
        public_ip, public_port = parse_stun_response(data, transaction_id)

        return public_ip, public_port
    finally:
        sock.close()

# Usage
public_ip, public_port = get_public_ip_port()
print(f"Public IP: {public_ip}:{public_port}")
</code></pre>
<h3 id="javascript-webrtc-example"><a class="header" href="#javascript-webrtc-example">JavaScript (WebRTC) Example</a></h3>
<pre><code class="language-javascript">// Create RTCPeerConnection with STUN server
const configuration = {
  iceServers: [
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:stun1.l.google.com:19302' }
  ]
};

const pc = new RTCPeerConnection(configuration);

// Listen for ICE candidates
pc.onicecandidate = (event) =&gt; {
  if (event.candidate) {
    console.log('ICE Candidate:', event.candidate);
    // Send candidate to remote peer via signaling
  }
};

// Create offer to trigger ICE gathering
pc.createOffer()
  .then(offer =&gt; pc.setLocalDescription(offer))
  .then(() =&gt; {
    // ICE candidates will be gathered
    // and onicecandidate will be called
  });
</code></pre>
<h2 id="public-stun-servers"><a class="header" href="#public-stun-servers">Public STUN Servers</a></h2>
<h3 id="free-stun-servers"><a class="header" href="#free-stun-servers">Free STUN Servers</a></h3>
<pre><code>Google:
  stun.l.google.com:19302
  stun1.l.google.com:19302
  stun2.l.google.com:19302
  stun3.l.google.com:19302
  stun4.l.google.com:19302

Twilio:
  global.stun.twilio.com:3478

OpenRelay:
  stun.relay.metered.ca:80
</code></pre>
<h3 id="testing-stun-server"><a class="header" href="#testing-stun-server">Testing STUN Server</a></h3>
<pre><code class="language-bash"># Using stunclient (stuntman tools)
stunclient stun.l.google.com

# Output example:
# Binding test: success
# Local address: 192.168.1.10:45678
# Mapped address: 203.0.113.5:45678
</code></pre>
<h2 id="stun-limitations"><a class="header" href="#stun-limitations">STUN Limitations</a></h2>
<h3 id="1-doesnt-work-with-symmetric-nat"><a class="header" href="#1-doesnt-work-with-symmetric-nat">1. Doesn’t Work with Symmetric NAT</a></h3>
<pre><code>STUN tells you: 203.0.113.5:6000
But when connecting to peer, NAT assigns: 203.0.113.5:6001

Peer can't connect to you
→ Need TURN relay
</code></pre>
<h3 id="2-requires-udp"><a class="header" href="#2-requires-udp">2. Requires UDP</a></h3>
<pre><code>Some networks block UDP
STUN won't work
→ Need TCP fallback or TURN over TCP
</code></pre>
<h3 id="3-firewall-issues"><a class="header" href="#3-firewall-issues">3. Firewall Issues</a></h3>
<pre><code>Restrictive firewalls may block P2P connections
Even with correct IP:port from STUN
→ Need TURN relay
</code></pre>
<h3 id="4-no-data-relay"><a class="header" href="#4-no-data-relay">4. No Data Relay</a></h3>
<pre><code>STUN only discovers address
Doesn't relay data
If direct connection fails, need TURN
</code></pre>
<h2 id="stun-vs-turn-vs-ice"><a class="header" href="#stun-vs-turn-vs-ice">STUN vs TURN vs ICE</a></h2>
<pre><code>STUN:
  - Discovers public IP:port
  - Lightweight
  - No bandwidth cost
  - Doesn't always work

TURN:
  - Relays traffic
  - Always works
  - Bandwidth intensive
  - Costs money

ICE:
  - Uses both STUN and TURN
  - Tries STUN first
  - Falls back to TURN
  - Best of both worlds
</code></pre>
<h2 id="stun-server-setup"><a class="header" href="#stun-server-setup">STUN Server Setup</a></h2>
<h3 id="using-coturn"><a class="header" href="#using-coturn">Using coturn</a></h3>
<pre><code class="language-bash"># Install
sudo apt-get install coturn

# Configure /etc/turnserver.conf
listening-port=3478
fingerprint
lt-cred-mech
use-auth-secret
static-auth-secret=YOUR_SECRET
realm=example.com
total-quota=100
stale-nonce=600
</code></pre>
<h3 id="run-stun-server"><a class="header" href="#run-stun-server">Run STUN Server</a></h3>
<pre><code class="language-bash"># Start server
sudo turnserver -v

# Test locally
stunclient localhost
</code></pre>
<h2 id="eli10"><a class="header" href="#eli10">ELI10</a></h2>
<p>STUN is like asking a friend “What’s my address?” when you can’t see it yourself:</p>
<p><strong>The Problem:</strong>
You live in an apartment building (NAT)
Someone outside wants to send you mail
They need your full address, not just “Apartment 5”</p>
<p><strong>STUN Solution:</strong></p>
<ol>
<li>You call a friend outside (STUN server)</li>
<li>Friend says: “I see your address as 123 Main St, Apartment 5”</li>
<li>You tell pen pal: “Send letters to 123 Main St, Apt 5”</li>
<li>Pen pal can now reach you!</li>
</ol>
<p><strong>NAT Types:</strong></p>
<ul>
<li><strong>Full Cone:</strong> Anyone can mail you once you have the address</li>
<li><strong>Restricted:</strong> Only people you mailed first can mail back</li>
<li><strong>Symmetric:</strong> Building assigns different box for each sender (hard!)</li>
</ul>
<p><strong>When STUN Doesn’t Work:</strong></p>
<ul>
<li>Symmetric NAT: Address changes for each recipient</li>
<li>Firewall: Building doesn’t accept outside mail</li>
<li>→ Need TURN (a forwarding service)</li>
</ul>
<p><strong>WebRTC Uses STUN:</strong></p>
<ul>
<li>Video calls discover how to reach each other</li>
<li>Try direct connection first (with STUN)</li>
<li>Use relay (TURN) if direct doesn’t work</li>
</ul>
<h2 id="further-resources"><a class="header" href="#further-resources">Further Resources</a></h2>
<ul>
<li><a href="https://tools.ietf.org/html/rfc5389">RFC 5389 - STUN Specification</a></li>
<li><a href="https://tools.ietf.org/html/rfc8489">RFC 8489 - STUN Update</a></li>
<li><a href="https://webrtc.org/">WebRTC and STUN</a></li>
<li><a href="https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/">Interactive STUN Test</a></li>
<li><a href="https://github.com/coturn/coturn">coturn Server</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../networking/firewalls.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../networking/turn.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../networking/firewalls.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../networking/turn.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../mark-09e88c2c.min.js"></script>
        <script src="../searcher-c2a407aa.js"></script>

        <script src="../clipboard-1626706a.min.js"></script>
        <script src="../highlight-abc7f01d.js"></script>
        <script src="../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
