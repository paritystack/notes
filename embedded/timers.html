<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Timers - My Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../css/general-2459343d.css">
        <link rel="stylesheet" href="../css/chrome-ae938929.css">
        <link rel="stylesheet" href="../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex-93581825.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc-a4fa5267.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">My Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="timers-and-counters"><a class="header" href="#timers-and-counters">Timers and Counters</a></h1>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>Timers and counters are essential hardware peripherals in microcontrollers that keep track of time, count events, generate precise delays, create PWM signals, and trigger interrupts at specific intervals. Unlike software delays (which block the CPU), hardware timers run independently, allowing your program to multitask efficiently.</p>
<h2 id="key-concepts"><a class="header" href="#key-concepts">Key Concepts</a></h2>
<h3 id="timer-vs-counter"><a class="header" href="#timer-vs-counter">Timer vs Counter</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Feature</th><th>Timer</th><th>Counter</th></tr>
</thead>
<tbody>
<tr><td><strong>Clock Source</strong></td><td>Internal (system clock)</td><td>External (GPIO pin)</td></tr>
<tr><td><strong>Purpose</strong></td><td>Measure time intervals</td><td>Count external events</td></tr>
<tr><td><strong>Speed</strong></td><td>Fixed by clock</td><td>Variable (event-driven)</td></tr>
<tr><td><strong>Example Use</strong></td><td>Generate 1ms interrupts</td><td>Count encoder pulses</td></tr>
</tbody>
</table>
</div>
<h3 id="timer-components"><a class="header" href="#timer-components">Timer Components</a></h3>
<ol>
<li><strong>Counter Register</strong>: Stores current count value</li>
<li><strong>Prescaler</strong>: Divides input clock to slow down counting</li>
<li><strong>Compare Register</strong>: Value to trigger events when matched</li>
<li><strong>Auto-reload Register</strong>: Value to reset counter to (for periodic timers)</li>
</ol>
<h3 id="timer-modes"><a class="header" href="#timer-modes">Timer Modes</a></h3>
<ol>
<li><strong>Basic Timer</strong>: Simple counting up or down</li>
<li><strong>PWM Mode</strong>: Generate pulse-width modulated signals</li>
<li><strong>Input Capture</strong>: Measure external signal timing</li>
<li><strong>Output Compare</strong>: Trigger events at specific times</li>
<li><strong>Encoder Mode</strong>: Read quadrature encoders</li>
</ol>
<h2 id="how-it-works"><a class="header" href="#how-it-works">How It Works</a></h2>
<h3 id="clock-and-prescaler"><a class="header" href="#clock-and-prescaler">Clock and Prescaler</a></h3>
<pre><code>System Clock (16 MHz)
    -&gt;
Prescaler (/256)
    -&gt;
Timer Clock (62.5 kHz)
    -&gt;
Counter increments at 62.5 kHz
</code></pre>
<p><strong>Formula</strong>:</p>
<pre><code>Timer Frequency = CPU Frequency / Prescaler

Timer Period = 1 / Timer Frequency

Overflow Time = (2^bits / Timer Frequency)
</code></pre>
<p><strong>Example</strong> (Arduino Uno - 16 MHz):</p>
<pre><code>Prescaler = 256
Timer Frequency = 16,000,000 / 256 = 62,500 Hz
Timer Period = 1 / 62,500 = 16 us per tick

For 8-bit timer (0-255):
Overflow Time = 256 * 16 us = 4.096 ms

For 16-bit timer (0-65535):
Overflow Time = 65,536 * 16 us = 1.048 seconds
</code></pre>
<h2 id="code-examples"><a class="header" href="#code-examples">Code Examples</a></h2>
<h3 id="arduino-timer-interrupt"><a class="header" href="#arduino-timer-interrupt">Arduino Timer Interrupt</a></h3>
<pre><code class="language-cpp">// Using Timer1 (16-bit) for 1ms interrupt

volatile unsigned long millisCounter = 0;

void setup() {
  Serial.begin(9600);

  // Stop interrupts during setup
  cli();

  // Reset Timer1
  TCCR1A = 0;
  TCCR1B = 0;
  TCNT1 = 0;

  // Set compare match register for 1ms
  // OCR1A = (16MHz / (prescaler * desired frequency)) - 1
  // OCR1A = (16,000,000 / (64 * 1000)) - 1 = 249
  OCR1A = 249;

  // Turn on CTC mode (Clear Timer on Compare Match)
  TCCR1B |= (1 &lt;&lt; WGM12);

  // Set CS11 and CS10 bits for 64 prescaler
  TCCR1B |= (1 &lt;&lt; CS11) | (1 &lt;&lt; CS10);

  // Enable timer compare interrupt
  TIMSK1 |= (1 &lt;&lt; OCIE1A);

  // Enable global interrupts
  sei();
}

// Timer1 interrupt service routine (ISR)
ISR(TIMER1_COMPA_vect) {
  millisCounter++;

  // Your code here - keep it SHORT!
  // DO NOT use Serial.print() in ISR
}

void loop() {
  // Use millisCounter instead of millis()
  static unsigned long lastPrint = 0;

  if (millisCounter - lastPrint &gt;= 1000) {
    lastPrint = millisCounter;
    Serial.println(millisCounter);
  }
}
</code></pre>
<h3 id="esp32-hardware-timer"><a class="header" href="#esp32-hardware-timer">ESP32 Hardware Timer</a></h3>
<pre><code class="language-cpp">// ESP32 has 4 hardware timers (0-3)

hw_timer_t *timer = NULL;
volatile uint32_t timerCounter = 0;

void IRAM_ATTR onTimer() {
  timerCounter++;
  // Keep ISR short and fast!
}

void setup() {
  Serial.begin(115200);

  // Initialize timer (timer number, prescaler, count up)
  // ESP32 clock is 80 MHz
  // Prescaler of 80 gives 1 MHz (1 tick = 1 us)
  timer = timerBegin(0, 80, true);

  // Attach interrupt function
  timerAttachInterrupt(timer, &amp;onTimer, true);

  // Set alarm to trigger every 1ms (1000 us)
  timerAlarmWrite(timer, 1000, true);  // true = auto-reload

  // Enable timer alarm
  timerAlarmEnable(timer);

  Serial.println("Timer initialized!");
}

void loop() {
  static uint32_t lastCount = 0;

  if (timerCounter - lastCount &gt;= 1000) {
    lastCount = timerCounter;
    Serial.print("Timer count: ");
    Serial.println(timerCounter);
  }
}

// Ticker library (easier alternative)
#include &lt;Ticker.h&gt;

Ticker ticker;
volatile int count = 0;

void timerCallback() {
  count++;
}

void setup() {
  // Call timerCallback every 0.001 seconds (1ms)
  ticker.attach(0.001, timerCallback);
}
</code></pre>
<h3 id="stm32-hal-timer"><a class="header" href="#stm32-hal-timer">STM32 HAL Timer</a></h3>
<pre><code class="language-c">#include "stm32f4xx_hal.h"

TIM_HandleTypeDef htim2;
volatile uint32_t timerTicks = 0;

void Timer_Init(void) {
    TIM_ClockConfigTypeDef sClockSourceConfig = {0};
    TIM_MasterConfigTypeDef sMasterConfig = {0};

    // TIM2 configuration
    // APB1 clock = 84 MHz (for STM32F4)
    // Prescaler = 8400 - 1 -&gt; 10 kHz timer clock
    // Period = 10 - 1 -&gt; 1 kHz interrupt (1ms)

    htim2.Instance = TIM2;
    htim2.Init.Prescaler = 8400 - 1;      // 84 MHz / 8400 = 10 kHz
    htim2.Init.CounterMode = TIM_COUNTERMODE_UP;
    htim2.Init.Period = 10 - 1;           // 10 kHz / 10 = 1 kHz (1ms)
    htim2.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
    htim2.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
    HAL_TIM_Base_Init(&amp;htim2);

    sClockSourceConfig.ClockSource = TIM_CLOCKSOURCE_INTERNAL;
    HAL_TIM_ConfigClockSource(&amp;htim2, &amp;sClockSourceConfig);

    // Enable timer interrupt
    HAL_TIM_Base_Start_IT(&amp;htim2);
}

// Timer interrupt callback
void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim) {
    if (htim-&gt;Instance == TIM2) {
        timerTicks++;
        // Your periodic code here
    }
}

// In main.c, enable interrupt in NVIC
void MX_TIM2_Init(void) {
    Timer_Init();
    HAL_NVIC_SetPriority(TIM2_IRQn, 0, 0);
    HAL_NVIC_EnableIRQ(TIM2_IRQn);
}
</code></pre>
<h3 id="pwm-generation-with-timers"><a class="header" href="#pwm-generation-with-timers">PWM Generation with Timers</a></h3>
<pre><code class="language-cpp">// Arduino PWM using Timer1

void setup() {
  // Set pins as output
  pinMode(9, OUTPUT);   // OC1A
  pinMode(10, OUTPUT);  // OC1B

  // Stop timer during configuration
  TCCR1A = 0;
  TCCR1B = 0;

  // Fast PWM mode, ICR1 as TOP
  // WGM13:0 = 14 (Fast PWM, TOP = ICR1)
  TCCR1A = (1 &lt;&lt; WGM11);
  TCCR1B = (1 &lt;&lt; WGM13) | (1 &lt;&lt; WGM12);

  // Non-inverting mode for both channels
  TCCR1A |= (1 &lt;&lt; COM1A1) | (1 &lt;&lt; COM1B1);

  // Prescaler = 8
  TCCR1B |= (1 &lt;&lt; CS11);

  // Set TOP value for desired frequency
  // PWM Frequency = F_CPU / (Prescaler * (1 + TOP))
  // For 50 Hz: TOP = 16,000,000 / (8 * 50) - 1 = 39999
  ICR1 = 39999;  // 50 Hz

  // Set duty cycle
  OCR1A = 3000;  // ~7.5% duty cycle on pin 9
  OCR1B = 6000;  // ~15% duty cycle on pin 10
}

// Servo control example
void setServoAngle(uint8_t angle) {
  // Servo expects 1ms-2ms pulse every 20ms (50 Hz)
  // 1ms = 0 degrees = 2000 counts
  // 1.5ms = 90 degrees = 3000 counts
  // 2ms = 180 degrees = 4000 counts

  uint16_t pulse = map(angle, 0, 180, 2000, 4000);
  OCR1A = pulse;
}

void loop() {
  setServoAngle(0);
  delay(1000);
  setServoAngle(90);
  delay(1000);
  setServoAngle(180);
  delay(1000);
}
</code></pre>
<h3 id="input-capture-mode"><a class="header" href="#input-capture-mode">Input Capture Mode</a></h3>
<pre><code class="language-cpp">// Measure frequency of external signal on pin 8 (ICP1)

volatile unsigned long captureTime1 = 0;
volatile unsigned long captureTime2 = 0;
volatile boolean newCapture = false;

void setup() {
  Serial.begin(9600);

  // Configure Timer1 for input capture
  TCCR1A = 0;
  TCCR1B = 0;

  // Prescaler = 64 (250 kHz timer, 4us resolution)
  TCCR1B |= (1 &lt;&lt; CS11) | (1 &lt;&lt; CS10);

  // Input Capture on rising edge
  TCCR1B |= (1 &lt;&lt; ICES1);

  // Enable input capture interrupt
  TIMSK1 |= (1 &lt;&lt; ICIE1);

  // Enable global interrupts
  sei();
}

// Input capture interrupt
ISR(TIMER1_CAPT_vect) {
  static boolean firstCapture = true;

  if (firstCapture) {
    captureTime1 = ICR1;
    firstCapture = false;
  } else {
    captureTime2 = ICR1;
    newCapture = true;
    firstCapture = true;
  }
}

void loop() {
  if (newCapture) {
    newCapture = false;

    // Calculate period
    unsigned long period = captureTime2 - captureTime1;

    // Calculate frequency
    // Timer runs at 250 kHz (4us per tick)
    float frequency = 250000.0 / period;

    Serial.print("Frequency: ");
    Serial.print(frequency);
    Serial.println(" Hz");
  }
}
</code></pre>
<h2 id="common-applications"><a class="header" href="#common-applications">Common Applications</a></h2>
<h3 id="1-precise-timing-without-delay"><a class="header" href="#1-precise-timing-without-delay">1. Precise Timing Without Delay</a></h3>
<pre><code class="language-cpp">unsigned long previousMillis = 0;
const long interval = 1000;

void loop() {
  unsigned long currentMillis = millis();

  if (currentMillis - previousMillis &gt;= interval) {
    previousMillis = currentMillis;

    // Execute every 1 second without blocking
    toggleLED();
  }

  // Other code runs continuously
  checkSensors();
  processData();
}
</code></pre>
<h3 id="2-multiple-periodic-tasks"><a class="header" href="#2-multiple-periodic-tasks">2. Multiple Periodic Tasks</a></h3>
<pre><code class="language-cpp">volatile uint32_t timerTicks = 0;

ISR(TIMER1_COMPA_vect) {
  timerTicks++;
}

void loop() {
  static uint32_t lastTask1 = 0;
  static uint32_t lastTask2 = 0;
  static uint32_t lastTask3 = 0;

  // Task 1: Every 10ms
  if (timerTicks - lastTask1 &gt;= 10) {
    lastTask1 = timerTicks;
    readSensors();
  }

  // Task 2: Every 100ms
  if (timerTicks - lastTask2 &gt;= 100) {
    lastTask2 = timerTicks;
    updateDisplay();
  }

  // Task 3: Every 1000ms
  if (timerTicks - lastTask3 &gt;= 1000) {
    lastTask3 = timerTicks;
    sendData();
  }
}
</code></pre>
<h3 id="3-watchdog-timer"><a class="header" href="#3-watchdog-timer">3. Watchdog Timer</a></h3>
<pre><code class="language-cpp">#include &lt;avr/wdt.h&gt;

void setup() {
  // Enable watchdog timer (8 second timeout)
  wdt_enable(WDTO_8S);
}

void loop() {
  // Do work
  processData();

  // Reset watchdog (prevent system reset)
  wdt_reset();

  // If code hangs, watchdog resets system after 8 seconds
}
</code></pre>
<h3 id="4-real-time-clock-rtc"><a class="header" href="#4-real-time-clock-rtc">4. Real-Time Clock (RTC)</a></h3>
<pre><code class="language-cpp">// Using timer to maintain time

volatile uint32_t seconds = 0;
volatile uint16_t milliseconds = 0;

ISR(TIMER1_COMPA_vect) {
  milliseconds++;

  if (milliseconds &gt;= 1000) {
    milliseconds = 0;
    seconds++;
  }
}

void getTime(uint8_t *hours, uint8_t *minutes, uint8_t *secs) {
  noInterrupts();
  uint32_t totalSeconds = seconds;
  interrupts();

  *hours = (totalSeconds / 3600) % 24;
  *minutes = (totalSeconds / 60) % 60;
  *secs = totalSeconds % 60;
}
</code></pre>
<h3 id="5-debouncing-buttons"><a class="header" href="#5-debouncing-buttons">5. Debouncing Buttons</a></h3>
<pre><code class="language-cpp">volatile uint32_t timerMs = 0;

ISR(TIMER1_COMPA_vect) {
  timerMs++;
}

const int buttonPin = 2;
const int debounceTime = 50;  // 50ms

bool readButtonDebounced() {
  static uint32_t lastDebounceTime = 0;
  static bool lastButtonState = HIGH;
  static bool buttonState = HIGH;

  bool reading = digitalRead(buttonPin);

  if (reading != lastButtonState) {
    lastDebounceTime = timerMs;
  }

  if ((timerMs - lastDebounceTime) &gt; debounceTime) {
    if (reading != buttonState) {
      buttonState = reading;
      return (buttonState == LOW);  // Return true on button press
    }
  }

  lastButtonState = reading;
  return false;
}
</code></pre>
<h2 id="timer-prescaler-values"><a class="header" href="#timer-prescaler-values">Timer Prescaler Values</a></h2>
<h3 id="avr-arduino-unonanomega"><a class="header" href="#avr-arduino-unonanomega">AVR (Arduino Uno/Nano/Mega)</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Prescaler</th><th>CS12</th><th>CS11</th><th>CS10</th><th>Timer Frequency (16 MHz)</th></tr>
</thead>
<tbody>
<tr><td>None</td><td>0</td><td>0</td><td>0</td><td>Stopped</td></tr>
<tr><td>1</td><td>0</td><td>0</td><td>1</td><td>16 MHz</td></tr>
<tr><td>8</td><td>0</td><td>1</td><td>0</td><td>2 MHz</td></tr>
<tr><td>64</td><td>0</td><td>1</td><td>1</td><td>250 kHz</td></tr>
<tr><td>256</td><td>1</td><td>0</td><td>0</td><td>62.5 kHz</td></tr>
<tr><td>1024</td><td>1</td><td>0</td><td>1</td><td>15.625 kHz</td></tr>
</tbody>
</table>
</div>
<h2 id="best-practices"><a class="header" href="#best-practices">Best Practices</a></h2>
<h3 id="1-keep-isrs-short-and-fast"><a class="header" href="#1-keep-isrs-short-and-fast">1. Keep ISRs Short and Fast</a></h3>
<pre><code class="language-cpp">// BAD - Don't do this in ISR!
ISR(TIMER1_COMPA_vect) {
  Serial.println("Timer fired");  // Serial is slow!
  delay(100);                      // Blocks other interrupts!
  float result = complexCalculation();  // Takes too long!
}

// GOOD - Set flags, process in main loop
volatile bool timerFlag = false;

ISR(TIMER1_COMPA_vect) {
  timerFlag = true;  // Just set a flag
}

void loop() {
  if (timerFlag) {
    timerFlag = false;
    Serial.println("Timer fired");  // Do slow stuff here
    processData();
  }
}
</code></pre>
<h3 id="2-protect-shared-variables"><a class="header" href="#2-protect-shared-variables">2. Protect Shared Variables</a></h3>
<pre><code class="language-cpp">volatile uint32_t sharedCounter = 0;

ISR(TIMER1_COMPA_vect) {
  sharedCounter++;
}

void loop() {
  // BAD - Not atomic! Can be corrupted if interrupt occurs mid-read
  uint32_t localCopy = sharedCounter;

  // GOOD - Disable interrupts during multi-byte read
  noInterrupts();
  uint32_t localCopy = sharedCounter;
  interrupts();

  Serial.println(localCopy);
}
</code></pre>
<h3 id="3-calculate-timer-values-correctly"><a class="header" href="#3-calculate-timer-values-correctly">3. Calculate Timer Values Correctly</a></h3>
<pre><code class="language-cpp">// Formula for CTC mode:
// Compare Value = (F_CPU / (Prescaler * Desired_Frequency)) - 1

#define F_CPU 16000000UL
#define PRESCALER 64
#define DESIRED_HZ 1000  // 1 kHz

uint16_t compareValue = (F_CPU / (PRESCALER * DESIRED_HZ)) - 1;
// compareValue = (16000000 / (64 * 1000)) - 1 = 249

OCR1A = compareValue;
</code></pre>
<h2 id="common-issues-and-debugging"><a class="header" href="#common-issues-and-debugging">Common Issues and Debugging</a></h2>
<h3 id="problem-timer-interrupt-not-firing"><a class="header" href="#problem-timer-interrupt-not-firing">Problem: Timer Interrupt Not Firing</a></h3>
<p><strong>Check</strong>:</p>
<ul>
<li>Global interrupts enabled (<code>sei()</code>)</li>
<li>Specific timer interrupt enabled</li>
<li>Prescaler and compare values calculated correctly</li>
<li>Clock source selected</li>
<li>ISR function name matches vector name</li>
</ul>
<h3 id="problem-inaccurate-timing"><a class="header" href="#problem-inaccurate-timing">Problem: Inaccurate Timing</a></h3>
<p><strong>Causes</strong>:</p>
<ul>
<li>Wrong prescaler calculation</li>
<li>Integer overflow in calculations</li>
<li>CPU frequency mismatch</li>
<li>Crystal tolerance</li>
</ul>
<h3 id="problem-system-becomes-unresponsive"><a class="header" href="#problem-system-becomes-unresponsive">Problem: System Becomes Unresponsive</a></h3>
<p><strong>Causes</strong>:</p>
<ul>
<li>ISR takes too long (blocks other code)</li>
<li>Interrupt firing too frequently</li>
<li>Infinite loop in ISR</li>
<li>Nested interrupts causing stack overflow</li>
</ul>
<h2 id="eli10-explain-like-im-10"><a class="header" href="#eli10-explain-like-im-10">ELI10 (Explain Like I’m 10)</a></h2>
<p>Imagine you have a special alarm clock that can do cool tricks:</p>
<ol>
<li>
<p><strong>Basic Timer</strong>: Counts from 0 to 100, then starts over. Like counting seconds!</p>
</li>
<li>
<p><strong>Prescaler</strong>: Instead of counting every second, you count every 10 seconds. It’s like skipping numbers to count slower.</p>
</li>
<li>
<p><strong>Compare Match</strong>: When the count reaches a special number (like 50), the alarm rings! Then it keeps counting.</p>
</li>
<li>
<p><strong>PWM</strong>: The alarm flashes a light on and off really fast. By changing how long it stays on vs off, you can make the light look dimmer or brighter!</p>
</li>
<li>
<p><strong>Input Capture</strong>: You press a button, and the timer remembers what number it was at. Press again, and you can figure out how long between presses!</p>
</li>
</ol>
<p>The coolest part? The timer runs by itself in the background - you don’t have to watch it! It’s like having a helper that tells you when it’s time to do something, while you focus on other tasks.</p>
<h2 id="further-resources"><a class="header" href="#further-resources">Further Resources</a></h2>
<ul>
<li><a href="https://www.arduino.cc/reference/en/language/functions/interrupts/interrupts/">Arduino Timer Interrupts</a></li>
<li><a href="http://www.protostack.com/blog/2011/01/comprehensive-guide-to-timers-on-avr/">AVR Timers Tutorial</a></li>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/timer.html">ESP32 Timer Documentation</a></li>
<li><a href="https://www.st.com/resource/en/application_note/cd00211314-stm32f101xx-and-stm32f103xx-rcc-configuration-examples-stmicroelectronics.pdf">STM32 Timer Cookbook</a></li>
<li><a href="https://docs.arduino.cc/learn/microcontrollers/analog-output">Secrets of Arduino PWM</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../embedded/interrupts.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../embedded/watchdog.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../embedded/interrupts.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../embedded/watchdog.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../mark-09e88c2c.min.js"></script>
        <script src="../searcher-c2a407aa.js"></script>

        <script src="../clipboard-1626706a.min.js"></script>
        <script src="../highlight-abc7f01d.js"></script>
        <script src="../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
