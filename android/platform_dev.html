<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Platform Dev - My Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../css/general-2459343d.css">
        <link rel="stylesheet" href="../css/chrome-ae938929.css">
        <link rel="stylesheet" href="../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex-4533cd47.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc-6ab6626f.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">My Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="android-platform-development"><a class="header" href="#android-platform-development">Android Platform Development</a></h1>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>Android platform development involves building, modifying, and customizing the Android operating system itself (AOSP - Android Open Source Project), as opposed to developing applications that run on Android. This includes working with framework code, system services, HAL implementations, and the Linux kernel.</p>
<h3 id="platform-development-vs-app-development"><a class="header" href="#platform-development-vs-app-development">Platform Development vs App Development</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Aspect</th><th>App Development</th><th>Platform Development</th></tr>
</thead>
<tbody>
<tr><td><strong>Scope</strong></td><td>Single application</td><td>Entire OS and framework</td></tr>
<tr><td><strong>Language</strong></td><td>Kotlin/Java</td><td>Java, C++, C, Go, Rust</td></tr>
<tr><td><strong>Build System</strong></td><td>Gradle</td><td>Soong/Blueprint (Android.bp)</td></tr>
<tr><td><strong>Output</strong></td><td>APK/AAB</td><td>System image (system.img, boot.img)</td></tr>
<tr><td><strong>Tools</strong></td><td>Android Studio</td><td>Repo, Soong, ADB, Fastboot</td></tr>
<tr><td><strong>Testing</strong></td><td>Emulator/Device</td><td>AOSP Emulator, Physical device flashing</td></tr>
<tr><td><strong>Distribution</strong></td><td>Google Play</td><td>Custom ROM, OEM builds</td></tr>
</tbody>
</table>
</div>
<h3 id="when-you-need-platform-development"><a class="header" href="#when-you-need-platform-development">When You Need Platform Development</a></h3>
<ul>
<li>Building custom ROMs (LineageOS, GrapheneOS, etc.)</li>
<li>OEM device customization</li>
<li>Adding system-level features</li>
<li>Implementing hardware support (HAL)</li>
<li>Security research and hardening</li>
<li>Contributing to AOSP</li>
<li>Embedded Android systems</li>
</ul>
<h2 id="environment-setup"><a class="header" href="#environment-setup">Environment Setup</a></h2>
<h3 id="system-requirements"><a class="header" href="#system-requirements">System Requirements</a></h3>
<p><strong>Hardware:</strong></p>
<ul>
<li>64-bit CPU</li>
<li>400GB+ free disk space (SSD recommended)</li>
<li>64GB+ RAM (128GB recommended for full builds)</li>
<li>Fast internet connection</li>
</ul>
<p><strong>Operating System:</strong></p>
<ul>
<li>Ubuntu 22.04 LTS (recommended)</li>
<li>Debian 11+</li>
<li>macOS (limited support)</li>
</ul>
<h3 id="installing-dependencies"><a class="header" href="#installing-dependencies">Installing Dependencies</a></h3>
<pre><code class="language-bash"># Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y \
    git-core gnupg flex bison build-essential zip curl zlib1g-dev \
    libc6-dev-i386 libncurses5 lib32ncurses5-dev x11proto-core-dev \
    libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc \
    unzip fontconfig python3 python3-pip rsync bc schedtool lzop \
    imagemagick libssl-dev repo ccache adb fastboot

# Configure Git
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"

# Install repo tool (alternative method)
mkdir -p ~/bin
curl https://storage.googleapis.com/git-repo-downloads/repo &gt; ~/bin/repo
chmod a+x ~/bin/repo
export PATH=~/bin:$PATH
</code></pre>
<h3 id="downloading-aosp-source"><a class="header" href="#downloading-aosp-source">Downloading AOSP Source</a></h3>
<pre><code class="language-bash"># Create working directory
mkdir -p ~/aosp
cd ~/aosp

# Initialize repo for specific Android version
# Android 14
repo init -u https://android.googlesource.com/platform/manifest -b android-14.0.0_r1

# Or latest master
repo init -u https://android.googlesource.com/platform/manifest -b master

# Sync source code (this takes hours)
repo sync -c -j$(nproc) --force-sync --no-clone-bundle --no-tags

# For faster subsequent syncs
repo sync -c -j$(nproc) --force-sync
</code></pre>
<h3 id="setting-up-build-environment"><a class="header" href="#setting-up-build-environment">Setting Up Build Environment</a></h3>
<pre><code class="language-bash"># Source build environment
cd ~/aosp
source build/envsetup.sh

# This adds important commands:
# - lunch: Select build target
# - m: Build from top of tree
# - mm: Build current directory
# - mma: Build current directory and dependencies
# - mmm: Build specific directory
# - croot: Change to repo root
# - cgrep: Search C/C++ files
# - jgrep: Search Java files
</code></pre>
<h2 id="aosp-directory-structure"><a class="header" href="#aosp-directory-structure">AOSP Directory Structure</a></h2>
<p>Understanding the source tree layout is crucial:</p>
<pre><code>aosp/
├── art/                    # Android Runtime (ART)
├── bionic/                 # C library, math, and dynamic linker
├── bootable/              # Boot and recovery related
│   └── recovery/          # Recovery mode implementation
├── build/                 # Build system
│   ├── soong/            # Soong build system (Go)
│   └── make/             # Legacy Make-based build
├── cts/                   # Compatibility Test Suite
├── dalvik/                # Dalvik VM (legacy)
├── developers/            # Sample apps and docs
├── development/           # Development tools
├── device/                # Device-specific configurations
│   ├── google/           # Google devices
│   └── [vendor]/[device]/ # Device configurations
├── external/              # External projects and libraries
│   ├── chromium-webview/
│   ├── sqlite/
│   └── ...
├── frameworks/            # Android framework
│   ├── base/             # Core framework (services, APIs)
│   ├── native/           # Native framework libraries
│   ├── av/               # Audio/Video framework
│   └── opt/              # Optional frameworks
├── hardware/              # HAL definitions and implementations
│   ├── interfaces/       # HIDL/AIDL interface definitions
│   ├── libhardware/      # Legacy HAL
│   └── [vendor]/         # Vendor HAL implementations
├── kernel/                # Kernel source (if included)
├── packages/              # System packages and apps
│   ├── apps/             # System apps (Settings, Dialer, etc.)
│   ├── services/         # System services
│   └── providers/        # Content providers
├── pdk/                   # Platform Development Kit
├── platform_testing/      # Platform tests
├── prebuilts/            # Prebuilt binaries and tools
│   ├── sdk/
│   └── gcc/
├── sdk/                   # SDK source
├── system/                # Core system components
│   ├── core/             # Init, toolbox, debuggerd
│   ├── bt/               # Bluetooth stack
│   ├── netd/             # Network daemon
│   └── vold/             # Volume daemon
├── toolchain/            # Toolchain utilities
├── tools/                # Development tools
├── vendor/               # Vendor-specific code
│   └── [vendor]/         # Vendor proprietary code
└── out/                  # Build output (created during build)
    └── target/
        └── product/
            └── [device]/  # Built images
</code></pre>
<h2 id="building-android-platform"><a class="header" href="#building-android-platform">Building Android Platform</a></h2>
<h3 id="selecting-build-target"><a class="header" href="#selecting-build-target">Selecting Build Target</a></h3>
<pre><code class="language-bash"># Source environment
source build/envsetup.sh

# List available targets
lunch

# Common targets:
# aosp_arm64-eng          - Generic ARM64, engineering build
# aosp_x86_64-eng         - Generic x86_64, engineering build
# aosp_cf_x86_64_phone-userdebug  - Cuttlefish virtual device

# Select target
lunch aosp_x86_64-eng
</code></pre>
<h3 id="build-variants"><a class="header" href="#build-variants">Build Variants</a></h3>
<ul>
<li>
<p><strong>eng</strong>: Engineering builds</p>
<ul>
<li>Debug enabled</li>
<li>Root access</li>
<li>Additional debugging tools</li>
<li>Not optimized</li>
</ul>
</li>
<li>
<p><strong>userdebug</strong>: User debug builds</p>
<ul>
<li>Root access available via adb</li>
<li>Production-like but debuggable</li>
<li>Most common for development</li>
</ul>
</li>
<li>
<p><strong>user</strong>: Production builds</p>
<ul>
<li>No root access</li>
<li>Optimized for performance</li>
<li>Production release configuration</li>
</ul>
</li>
</ul>
<h3 id="building-the-platform"><a class="header" href="#building-the-platform">Building the Platform</a></h3>
<pre><code class="language-bash"># Full build (clean build)
m -j$(nproc)

# This typically takes 1-6 hours depending on hardware

# Incremental build (after changes)
m -j$(nproc)

# Build specific module
m [module_name]

# Examples:
m SystemUI              # Build System UI
m framework            # Build framework
m services             # Build system services

# Build with verbose output
m showcommands

# Clean build
m clean                # Clean all
m installclean        # Clean installed files (faster)
</code></pre>
<h3 id="build-output"><a class="header" href="#build-output">Build Output</a></h3>
<p>After successful build, images are located in:</p>
<pre><code>out/target/product/[device]/
├── system.img          # System partition
├── vendor.img          # Vendor partition
├── boot.img           # Boot image (kernel + ramdisk)
├── userdata.img       # User data partition
├── recovery.img       # Recovery image
├── vbmeta.img         # Verified boot metadata
└── [device]-img.zip   # Flashable images package
</code></pre>
<h2 id="common-platform-development-patterns"><a class="header" href="#common-platform-development-patterns">Common Platform Development Patterns</a></h2>
<h3 id="1-adding-a-system-service"><a class="header" href="#1-adding-a-system-service">1. Adding a System Service</a></h3>
<p>System services are core platform components that provide functionality to apps.</p>
<h4 id="define-service-interface"><a class="header" href="#define-service-interface">Define Service Interface</a></h4>
<pre><code class="language-java">// frameworks/base/core/java/android/os/IMyService.aidl
package android.os;

/** {@hide} */
interface IMyService {
    String getMessage();
    void setMessage(String message);
}
</code></pre>
<h4 id="implement-service"><a class="header" href="#implement-service">Implement Service</a></h4>
<pre><code class="language-java">// frameworks/base/services/core/java/com/android/server/MyService.java
package com.android.server;

import android.content.Context;
import android.os.IMyService;

public class MyService extends IMyService.Stub {
    private final Context mContext;
    private String mMessage = "Default message";

    public MyService(Context context) {
        mContext = context;
    }

    @Override
    public String getMessage() {
        return mMessage;
    }

    @Override
    public void setMessage(String message) {
        mMessage = message;
        // You might want to persist this
    }

    public void onStart() {
        // Service initialization
    }
}
</code></pre>
<h4 id="register-service"><a class="header" href="#register-service">Register Service</a></h4>
<pre><code class="language-java">// frameworks/base/services/java/com/android/server/SystemServer.java

import com.android.server.MyService;

private void startOtherServices() {
    // ... existing services ...

    MyService myService = null;
    try {
        Slog.i(TAG, "My Service");
        myService = new MyService(context);
        ServiceManager.addService("myservice", myService);
    } catch (Throwable e) {
        reportWtf("starting My Service", e);
    }

    // ... more services ...
}
</code></pre>
<h4 id="create-client-api"><a class="header" href="#create-client-api">Create Client API</a></h4>
<pre><code class="language-java">// frameworks/base/core/java/android/os/MyManager.java
package android.os;

import android.annotation.SystemService;
import android.content.Context;

@SystemService(Context.MY_SERVICE)
public class MyManager {
    private final IMyService mService;

    /** {@hide} */
    public MyManager(Context context, IMyService service) {
        mService = service;
    }

    public String getMessage() {
        try {
            return mService.getMessage();
        } catch (RemoteException e) {
            throw e.rethrowFromSystemServer();
        }
    }

    public void setMessage(String message) {
        try {
            mService.setMessage(message);
        } catch (RemoteException e) {
            throw e.rethrowFromSystemServer();
        }
    }
}
</code></pre>
<h4 id="register-in-context"><a class="header" href="#register-in-context">Register in Context</a></h4>
<pre><code class="language-java">// frameworks/base/core/java/android/app/SystemServiceRegistry.java

import android.os.MyManager;

static {
    // ... existing service registrations ...

    registerService(Context.MY_SERVICE, MyManager.class,
        new CachedServiceFetcher&lt;MyManager&gt;() {
            @Override
            public MyManager createService(ContextImpl ctx) {
                IBinder b = ServiceManager.getService(Context.MY_SERVICE);
                IMyService service = IMyService.Stub.asInterface(b);
                return new MyManager(ctx, service);
            }
        });
}
</code></pre>
<h3 id="2-adding-system-api"><a class="header" href="#2-adding-system-api">2. Adding System API</a></h3>
<p>System APIs are hidden APIs accessible only to system apps.</p>
<pre><code class="language-java">// frameworks/base/core/java/android/os/SystemProperties.java

/**
 * Get system property value
 * @hide
 */
@SystemApi
public static String getSystemProperty(String key, String defaultValue) {
    return SystemProperties.get(key, defaultValue);
}
</code></pre>
<p>Mark in API definition:</p>
<pre><code class="language-java">/**
 * @hide
 */
@SystemApi
@RequiresPermission(android.Manifest.permission.READ_PRIVILEGED_PHONE_STATE)
public void privilegedMethod() {
    // Implementation
}
</code></pre>
<h3 id="3-adding-system-permissions"><a class="header" href="#3-adding-system-permissions">3. Adding System Permissions</a></h3>
<h4 id="define-permission"><a class="header" href="#define-permission">Define Permission</a></h4>
<pre><code class="language-xml">&lt;!-- frameworks/base/core/res/AndroidManifest.xml --&gt;

&lt;permission
    android:name="android.permission.MY_CUSTOM_PERMISSION"
    android:protectionLevel="signature|privileged"
    android:label="@string/permlab_myCustomPermission"
    android:description="@string/permdesc_myCustomPermission" /&gt;
</code></pre>
<p>Protection levels:</p>
<ul>
<li><strong>normal</strong>: Low-risk, granted automatically</li>
<li><strong>dangerous</strong>: Runtime permission required</li>
<li><strong>signature</strong>: Only apps signed with same key</li>
<li><strong>privileged</strong>: System apps in priv-app</li>
<li><strong>signature|privileged</strong>: Signature OR privileged</li>
</ul>
<h4 id="check-permission-in-service"><a class="header" href="#check-permission-in-service">Check Permission in Service</a></h4>
<pre><code class="language-java">// frameworks/base/services/core/java/com/android/server/MyService.java

public void privilegedOperation() {
    mContext.enforceCallingOrSelfPermission(
        android.Manifest.permission.MY_CUSTOM_PERMISSION,
        "Requires MY_CUSTOM_PERMISSION");

    // Perform operation
}
</code></pre>
<h3 id="4-modifying-framework-behavior"><a class="header" href="#4-modifying-framework-behavior">4. Modifying Framework Behavior</a></h3>
<p>Example: Modifying ActivityManagerService</p>
<pre><code class="language-java">// frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java

public class ActivityManagerService extends IActivityManager.Stub {

    // Add custom behavior
    @Override
    public void startActivity(/* parameters */) {
        // Custom pre-processing
        Slog.d(TAG, "Custom: Starting activity");

        // Original logic
        super.startActivity(/* parameters */);

        // Custom post-processing
        notifyCustomListeners();
    }
}
</code></pre>
<h3 id="5-adding-selinux-policies"><a class="header" href="#5-adding-selinux-policies">5. Adding SELinux Policies</a></h3>
<p>SELinux (Security-Enhanced Linux) controls access between processes.</p>
<h4 id="define-selinux-type"><a class="header" href="#define-selinux-type">Define SELinux Type</a></h4>
<pre><code class="language-te"># system/sepolicy/private/myservice.te

type myservice, domain;
type myservice_exec, exec_type, file_type;

# Allow myservice to be started by init
init_daemon_domain(myservice)

# Allow reading/writing specific files
allow myservice system_data_file:dir rw_dir_perms;
allow myservice system_data_file:file create_file_perms;

# Allow binder communication
binder_use(myservice)
binder_call(myservice, system_server)
</code></pre>
<h4 id="file-context-labeling"><a class="header" href="#file-context-labeling">File Context Labeling</a></h4>
<pre><code># system/sepolicy/private/file_contexts

/system/bin/myservice    u:object_r:myservice_exec:s0
/data/system/myservice(/.*)? u:object_r:system_data_file:s0
</code></pre>
<h3 id="6-hardware-abstraction-layer-hal"><a class="header" href="#6-hardware-abstraction-layer-hal">6. Hardware Abstraction Layer (HAL)</a></h3>
<p>Modern HALs use HIDL (Hardware Interface Definition Language) or AIDL.</p>
<h4 id="define-hidl-interface"><a class="header" href="#define-hidl-interface">Define HIDL Interface</a></h4>
<pre><code class="language-java">// hardware/interfaces/mydevice/1.0/IMyDevice.hal

package android.hardware.mydevice@1.0;

interface IMyDevice {
    /**
     * Initialize device
     * @return status Operation status
     */
    initialize() generates (Status status);

    /**
     * Read data from device
     * @return status Operation status
     * @return data Data read from device
     */
    readData() generates (Status status, vec&lt;uint8_t&gt; data);

    /**
     * Write data to device
     * @param data Data to write
     * @return status Operation status
     */
    writeData(vec&lt;uint8_t&gt; data) generates (Status status);
};
</code></pre>
<h4 id="implement-hal"><a class="header" href="#implement-hal">Implement HAL</a></h4>
<pre><code class="language-cpp">// hardware/interfaces/mydevice/1.0/default/MyDevice.cpp

#include &lt;android/hardware/mydevice/1.0/IMyDevice.h&gt;

namespace android::hardware::mydevice::V1_0::implementation {

class MyDevice : public IMyDevice {
public:
    Return&lt;Status&gt; initialize() override {
        // Initialize hardware
        return Status::OK;
    }

    Return&lt;void&gt; readData(readData_cb _hidl_cb) override {
        std::vector&lt;uint8_t&gt; data;
        // Read from hardware
        _hidl_cb(Status::OK, data);
        return Void();
    }

    Return&lt;Status&gt; writeData(const hidl_vec&lt;uint8_t&gt;&amp; data) override {
        // Write to hardware
        return Status::OK;
    }
};

} // namespace
</code></pre>
<h2 id="build-system-soong"><a class="header" href="#build-system-soong">Build System (Soong)</a></h2>
<p>Android uses Soong build system defined in <code>Android.bp</code> files.</p>
<h3 id="basic-androidbp-structure"><a class="header" href="#basic-androidbp-structure">Basic Android.bp Structure</a></h3>
<pre><code class="language-bp">// Android.bp

// Java library
java_library {
    name: "my-library",
    srcs: ["src/**/*.java"],
    sdk_version: "current",

    static_libs: [
        "androidx.core_core",
    ],

    libs: [
        "framework",
    ],
}

// System app
android_app {
    name: "MySystemApp",
    srcs: ["src/**/*.java"],
    resource_dirs: ["res"],
    manifest: "AndroidManifest.xml",

    platform_apis: true,
    certificate: "platform",
    privileged: true,

    static_libs: [
        "my-library",
    ],
}

// Native library
cc_library_shared {
    name: "libmynative",
    srcs: ["native/*.cpp"],

    shared_libs: [
        "liblog",
        "libutils",
    ],

    cflags: [
        "-Wall",
        "-Werror",
    ],
}

// Native binary
cc_binary {
    name: "myservice",
    srcs: ["service/*.cpp"],

    shared_libs: [
        "libmynative",
        "libbinder",
    ],

    init_rc: ["myservice.rc"],
}

// Prebuilt APK
android_app_import {
    name: "PrebuiltApp",
    apk: "prebuilt/app.apk",
    certificate: "PRESIGNED",
    privileged: true,
}
</code></pre>
<h3 id="module-types"><a class="header" href="#module-types">Module Types</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Type</th><th>Purpose</th><th>Example</th></tr>
</thead>
<tbody>
<tr><td><code>java_library</code></td><td>Java library</td><td>Framework libraries</td></tr>
<tr><td><code>android_app</code></td><td>Android application</td><td>System apps</td></tr>
<tr><td><code>android_app_import</code></td><td>Prebuilt APK</td><td>Vendor apps</td></tr>
<tr><td><code>cc_library</code></td><td>Native library</td><td>libutils</td></tr>
<tr><td><code>cc_binary</code></td><td>Native executable</td><td>surfaceflinger</td></tr>
<tr><td><code>cc_library_shared</code></td><td>Shared native library</td><td>.so files</td></tr>
<tr><td><code>cc_library_static</code></td><td>Static native library</td><td>.a files</td></tr>
<tr><td><code>prebuilt_etc</code></td><td>Config/data files</td><td>init scripts</td></tr>
<tr><td><code>sh_binary</code></td><td>Shell script</td><td>Utility scripts</td></tr>
</tbody>
</table>
</div>
<h3 id="common-build-properties"><a class="header" href="#common-build-properties">Common Build Properties</a></h3>
<pre><code class="language-bp">android_app {
    name: "MyApp",

    // Source files
    srcs: ["src/**/*.java"],
    resource_dirs: ["res"],
    manifest: "AndroidManifest.xml",

    // SDK version
    platform_apis: true,  // or sdk_version: "current"
    min_sdk_version: "30",

    // Signing
    certificate: "platform",  // platform, shared, media, testkey

    // Privileges
    privileged: true,  // Install in /system/priv-app
    system_ext_specific: true,  // Install in /system_ext
    product_specific: true,  // Install in /product
    vendor: true,  // Install in /vendor

    // Dependencies
    static_libs: ["lib1", "lib2"],
    libs: ["framework"],

    // Optimization
    optimize: {
        enabled: true,
        shrink: true,
        obfuscate: false,
    },

    // Overrides (replaces existing app)
    overrides: ["OriginalApp"],
}
</code></pre>
<h3 id="building-specific-modules"><a class="header" href="#building-specific-modules">Building Specific Modules</a></h3>
<pre><code class="language-bash"># Build specific module
m MySystemApp

# Build and install to device
m MySystemApp &amp;&amp; adb sync

# Build all modules in current directory
mm

# Build module and dependencies
mma

# Build modules in specific directory
mmm frameworks/base/packages/SystemUI/
</code></pre>
<h2 id="device-configuration"><a class="header" href="#device-configuration">Device Configuration</a></h2>
<h3 id="device-makefile-structure"><a class="header" href="#device-makefile-structure">Device Makefile Structure</a></h3>
<pre><code>device/manufacturer/codename/
├── Android.mk
├── AndroidProducts.mk
├── BoardConfig.mk
├── device.mk
├── [codename].mk
├── system.prop
├── vendor.prop
├── proprietary-files.txt
├── extract-files.sh
├── setup-makefiles.sh
├── overlay/           # Runtime resource overlays
├── sepolicy/         # Device-specific SELinux policies
├── init/            # Init scripts
│   ├── init.device.rc
│   └── ueventd.device.rc
├── configs/         # Hardware configs
│   ├── audio/
│   ├── wifi/
│   └── media/
└── kernel/          # Kernel build config
</code></pre>
<h3 id="devicemk-example"><a class="header" href="#devicemk-example">device.mk Example</a></h3>
<pre><code class="language-makefile"># device/manufacturer/codename/device.mk

# Inherit from common device config
$(call inherit-product, $(SRC_TARGET_DIR)/product/core_64_bit.mk)
$(call inherit-product, $(SRC_TARGET_DIR)/product/full_base_telephony.mk)

# Device identifier
PRODUCT_NAME := aosp_codename
PRODUCT_DEVICE := codename
PRODUCT_BRAND := Manufacturer
PRODUCT_MODEL := Device Model
PRODUCT_MANUFACTURER := manufacturer

# Build properties
PRODUCT_PROPERTY_OVERRIDES += \
    ro.build.fingerprint=custom-fingerprint \
    ro.product.board=codename

# Packages to include
PRODUCT_PACKAGES += \
    SystemUI \
    Settings \
    Launcher3 \
    MyCustomApp

# Copy device-specific files
PRODUCT_COPY_FILES += \
    $(LOCAL_PATH)/configs/audio/audio_policy.conf:$(TARGET_COPY_OUT_VENDOR)/etc/audio_policy.conf \
    $(LOCAL_PATH)/init/init.device.rc:$(TARGET_COPY_OUT_VENDOR)/etc/init/init.device.rc

# Vendor partition
$(call inherit-product, vendor/manufacturer/codename/codename-vendor.mk)
</code></pre>
<h3 id="boardconfigmk-example"><a class="header" href="#boardconfigmk-example">BoardConfig.mk Example</a></h3>
<pre><code class="language-makefile"># device/manufacturer/codename/BoardConfig.mk

# Architecture
TARGET_ARCH := arm64
TARGET_ARCH_VARIANT := armv8-a
TARGET_CPU_ABI := arm64-v8a
TARGET_CPU_VARIANT := generic

TARGET_2ND_ARCH := arm
TARGET_2ND_ARCH_VARIANT := armv7-a-neon
TARGET_2ND_CPU_ABI := armeabi-v7a
TARGET_2ND_CPU_VARIANT := generic

# Bootloader
TARGET_BOOTLOADER_BOARD_NAME := codename
TARGET_NO_BOOTLOADER := true

# Kernel
BOARD_KERNEL_CMDLINE := console=ttyMSM0,115200n8
BOARD_KERNEL_BASE := 0x80000000
BOARD_KERNEL_PAGESIZE := 4096
TARGET_PREBUILT_KERNEL := $(LOCAL_PATH)/kernel
# Or build from source:
# TARGET_KERNEL_SOURCE := kernel/manufacturer/codename
# TARGET_KERNEL_CONFIG := codename_defconfig

# Partitions
BOARD_FLASH_BLOCK_SIZE := 131072
BOARD_BOOTIMAGE_PARTITION_SIZE := 67108864
BOARD_SYSTEMIMAGE_PARTITION_SIZE := 3221225472
BOARD_USERDATAIMAGE_PARTITION_SIZE := 10737418240
BOARD_VENDORIMAGE_PARTITION_SIZE := 1073741824

# Filesystem
TARGET_USERIMAGES_USE_EXT4 := true
TARGET_USERIMAGES_USE_F2FS := true
BOARD_VENDORIMAGE_FILE_SYSTEM_TYPE := ext4

# SELinux
BOARD_SEPOLICY_DIRS += $(LOCAL_PATH)/sepolicy/vendor
SELINUX_IGNORE_NEVERALLOWS := true

# Verified Boot
BOARD_AVB_ENABLE := true
BOARD_AVB_MAKE_VBMETA_IMAGE_ARGS += --flag 2
</code></pre>
<h2 id="testing-and-debugging"><a class="header" href="#testing-and-debugging">Testing and Debugging</a></h2>
<h3 id="running-on-emulator"><a class="header" href="#running-on-emulator">Running on Emulator</a></h3>
<pre><code class="language-bash"># Build emulator target
lunch aosp_x86_64-eng
m -j$(nproc)

# Run emulator
emulator

# Or with specific options
emulator -memory 4096 -cores 4 -gpu host
</code></pre>
<h3 id="flashing-physical-device"><a class="header" href="#flashing-physical-device">Flashing Physical Device</a></h3>
<pre><code class="language-bash"># Boot into bootloader
adb reboot bootloader

# Unlock bootloader (if needed, wipes data)
fastboot flashing unlock

# Flash images
fastboot flashall -w

# Or flash individually
fastboot flash boot out/target/product/[device]/boot.img
fastboot flash system out/target/product/[device]/system.img
fastboot flash vendor out/target/product/[device]/vendor.img

# Reboot
fastboot reboot

# Lock bootloader (optional)
fastboot flashing lock
</code></pre>
<h3 id="debugging-platform-code"><a class="header" href="#debugging-platform-code">Debugging Platform Code</a></h3>
<pre><code class="language-bash"># View logs
adb logcat

# Filter by tag
adb logcat -s MyService

# View system server logs
adb logcat | grep SystemServer

# View kernel logs
adb shell dmesg

# Interactive debugging with GDB
gdbclient -p [process-name]

# Trace system calls
adb shell strace -p [pid]
</code></pre>
<h3 id="testing-changes"><a class="header" href="#testing-changes">Testing Changes</a></h3>
<pre><code class="language-bash"># Build and sync to device
m -j$(nproc) &amp;&amp; adb sync

# Sync only system partition
adb sync system

# Restart specific service
adb shell stop [service]
adb shell start [service]

# Restart system server (careful - disruptive)
adb shell stop
adb shell start

# Reboot to recovery
adb reboot recovery

# Reboot to bootloader
adb reboot bootloader
</code></pre>
<h2 id="common-operations"><a class="header" href="#common-operations">Common Operations</a></h2>
<h3 id="adding-system-application"><a class="header" href="#adding-system-application">Adding System Application</a></h3>
<ol>
<li><strong>Create app module</strong>:</li>
</ol>
<pre><code>packages/apps/MySystemApp/
├── Android.bp
├── AndroidManifest.xml
├── src/
└── res/
</code></pre>
<ol start="2">
<li><strong>Define in Android.bp</strong>:</li>
</ol>
<pre><code class="language-bp">android_app {
    name: "MySystemApp",
    srcs: ["src/**/*.java"],
    resource_dirs: ["res"],
    manifest: "AndroidManifest.xml",
    platform_apis: true,
    certificate: "platform",
    privileged: true,
}
</code></pre>
<ol start="3">
<li><strong>Add to device.mk</strong>:</li>
</ol>
<pre><code class="language-makefile">PRODUCT_PACKAGES += MySystemApp
</code></pre>
<h3 id="creating-system-service"><a class="header" href="#creating-system-service">Creating System Service</a></h3>
<p>Follow the pattern in “Adding a System Service” section, then:</p>
<pre><code class="language-bash"># Build framework
m framework services

# Sync to device
adb sync system

# Restart system
adb shell stop &amp;&amp; adb shell start
</code></pre>
<h3 id="modifying-system-properties"><a class="header" href="#modifying-system-properties">Modifying System Properties</a></h3>
<pre><code class="language-bash"># Edit system properties
vim device/manufacturer/codename/system.prop

# Add properties:
# ro.my.property=value
# persist.my.property=value

# Rebuild and flash
m -j$(nproc)
fastboot flashall
</code></pre>
<h3 id="creating-ota-package"><a class="header" href="#creating-ota-package">Creating OTA Package</a></h3>
<pre><code class="language-bash"># Build target files
m target-files-package

# Generate OTA
./build/tools/releasetools/ota_from_target_files \
    out/target/product/[device]/obj/PACKAGING/target_files_intermediates/aosp_[device]-target_files.zip \
    ota-package.zip

# Apply OTA
adb sideload ota-package.zip
</code></pre>
<h3 id="enabling-root-in-user-builds"><a class="header" href="#enabling-root-in-user-builds">Enabling Root in User Builds</a></h3>
<pre><code class="language-bash"># Edit device.mk
PRODUCT_PROPERTY_OVERRIDES += \
    ro.secure=0 \
    ro.debuggable=1 \
    ro.adb.secure=0

# Or use userdebug/eng variants
lunch aosp_[device]-userdebug
</code></pre>
<h2 id="advanced-topics"><a class="header" href="#advanced-topics">Advanced Topics</a></h2>
<h3 id="project-treble"><a class="header" href="#project-treble">Project Treble</a></h3>
<p>Treble separates vendor implementation from Android framework:</p>
<pre><code>┌─────────────────────────────┐
│   Android Framework         │  /system
├─────────────────────────────┤
│   VNDK (Vendor NDK)         │  ABI stability
├─────────────────────────────┤
│   Vendor Implementation     │  /vendor
│   (HALs, Drivers)           │
└─────────────────────────────┘
</code></pre>
<p><strong>Key Concepts:</strong></p>
<ul>
<li><strong>VNDK</strong>: Vendor NDK libraries with stable ABI</li>
<li><strong>Vendor Interface</strong>: HIDL/AIDL HALs</li>
<li><strong>Partition Separation</strong>: /system vs /vendor</li>
</ul>
<h3 id="generic-kernel-image-gki"><a class="header" href="#generic-kernel-image-gki">Generic Kernel Image (GKI)</a></h3>
<p>Android 11+ uses GKI for vendor-independent kernel:</p>
<pre><code class="language-bash"># GKI structure
kernel/
├── common/              # GKI kernel
└── common-modules/     # Loadable kernel modules

# Build GKI
cd kernel/common
BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh
</code></pre>
<h3 id="mainline-modules-apex"><a class="header" href="#mainline-modules-apex">Mainline Modules (APEX)</a></h3>
<p>Updatable system components delivered via Google Play:</p>
<pre><code class="language-bp">// APEX module definition
apex {
    name: "com.android.mymodule",
    manifest: "manifest.json",
    file_contexts: "file_contexts",
    key: "com.android.mymodule.key",
    certificate: ":com.android.mymodule.certificate",

    java_libs: [
        "mymodule-lib",
    ],

    prebuilts: [
        "mymodule-config",
    ],
}
</code></pre>
<h3 id="vendor-apex"><a class="header" href="#vendor-apex">Vendor APEX</a></h3>
<pre><code class="language-json">// manifest.json
{
  "name": "com.android.mymodule",
  "version": 1
}
</code></pre>
<h3 id="cts-compatibility-test-suite"><a class="header" href="#cts-compatibility-test-suite">CTS (Compatibility Test Suite)</a></h3>
<pre><code class="language-bash"># Run CTS
cd android-cts/tools
./cts-tradefed

# Run specific test
run cts -m CtsPermissionTestCases

# Run VTS (Vendor Test Suite)
./vts-tradefed
run vts
</code></pre>
<h2 id="development-workflow"><a class="header" href="#development-workflow">Development Workflow</a></h2>
<h3 id="making-changes"><a class="header" href="#making-changes">Making Changes</a></h3>
<pre><code class="language-bash"># 1. Create topic branch
repo start my-feature .

# 2. Make changes
vim frameworks/base/core/java/android/app/Activity.java

# 3. Build and test
m -j$(nproc)
adb sync
# Test changes

# 4. Commit
git add -A
git commit -m "Add feature X

Bug: 123456
Test: Manual testing on device
Change-Id: I..."
</code></pre>
<h3 id="code-review-gerrit"><a class="header" href="#code-review-gerrit">Code Review (Gerrit)</a></h3>
<pre><code class="language-bash"># Upload for review
repo upload .

# Or with git
git push ssh://[user]@android-review.googlesource.com:29418/platform/frameworks/base HEAD:refs/for/master

# Amend and re-upload
git commit --amend
repo upload .
</code></pre>
<h3 id="syncing-updates"><a class="header" href="#syncing-updates">Syncing Updates</a></h3>
<pre><code class="language-bash"># Sync all projects
repo sync -c -j$(nproc)

# Sync specific project
repo sync frameworks/base

# Rebase local changes
repo rebase
</code></pre>
<h2 id="performance-optimization"><a class="header" href="#performance-optimization">Performance Optimization</a></h2>
<h3 id="build-performance"><a class="header" href="#build-performance">Build Performance</a></h3>
<pre><code class="language-bash"># Use ccache
export USE_CCACHE=1
export CCACHE_DIR=~/.ccache
ccache -M 100G

# Parallel builds
m -j$(nproc)

# Incremental builds
m installclean  # Instead of clean
</code></pre>
<h3 id="runtime-performance"><a class="header" href="#runtime-performance">Runtime Performance</a></h3>
<pre><code class="language-java">// Optimize framework code
public class MyService {
    // Use object pools
    private final Pools.SynchronizedPool&lt;Message&gt; mPool
        = new Pools.SynchronizedPool&lt;&gt;(10);

    // Avoid allocations in hot paths
    private final ArrayList&lt;Item&gt; mReusableList = new ArrayList&lt;&gt;();

    public void processItems() {
        mReusableList.clear();
        // Reuse list instead of creating new
    }
}
</code></pre>
<h3 id="memory-optimization"><a class="header" href="#memory-optimization">Memory Optimization</a></h3>
<pre><code class="language-java">// Use weak references for callbacks
private final WeakHashMap&lt;Context, Callback&gt; mCallbacks
    = new WeakHashMap&lt;&gt;();

// Clear large data structures
@Override
public void onDestroy() {
    mLargeCache.clear();
    mBitmapCache.clear();
}
</code></pre>
<h2 id="best-practices"><a class="header" href="#best-practices">Best Practices</a></h2>
<h3 id="code-style"><a class="header" href="#code-style">Code Style</a></h3>
<ul>
<li>Follow <a href="https://source.android.com/docs/setup/contribute/code-style">AOSP Java Code Style</a></li>
<li>Use 4 spaces for indentation</li>
<li>Line length: 100 characters</li>
<li>Use meaningful variable names</li>
</ul>
<h3 id="security"><a class="header" href="#security">Security</a></h3>
<pre><code class="language-java">// Always validate input
public void handleData(String input) {
    if (input == null || input.isEmpty()) {
        throw new IllegalArgumentException("Invalid input");
    }

    // Sanitize before use
    String sanitized = input.replaceAll("[^a-zA-Z0-9]", "");
}

// Check permissions
mContext.enforceCallingPermission(
    android.Manifest.permission.MY_PERMISSION,
    "Requires MY_PERMISSION");

// Use SELinux policies
// Define in sepolicy/
</code></pre>
<h3 id="logging"><a class="header" href="#logging">Logging</a></h3>
<pre><code class="language-java">import android.util.Slog;

// System server logging
Slog.d(TAG, "Debug message");
Slog.i(TAG, "Info message");
Slog.w(TAG, "Warning message");
Slog.e(TAG, "Error message");

// App logging
android.util.Log.d(TAG, "Message");

// Conditional logging
if (DEBUG) {
    Slog.v(TAG, "Verbose debug info");
}
</code></pre>
<h3 id="error-handling"><a class="header" href="#error-handling">Error Handling</a></h3>
<pre><code class="language-java">try {
    riskyOperation();
} catch (Exception e) {
    Slog.e(TAG, "Operation failed", e);
    // Report to system
    if (mContext != null) {
        mContext.sendBroadcast(new Intent(ACTION_ERROR));
    }
}
</code></pre>
<h2 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h2>
<h3 id="build-issues"><a class="header" href="#build-issues">Build Issues</a></h3>
<pre><code class="language-bash"># Clean build
make clean
m -j$(nproc)

# Check dependencies
m modules
m nothing

# Fix repo state
repo forall -c 'git reset --hard'
repo sync -j$(nproc)
</code></pre>
<h3 id="boot-issues"><a class="header" href="#boot-issues">Boot Issues</a></h3>
<pre><code class="language-bash"># Check boot logs
adb wait-for-device
adb logcat -b all

# Kernel logs
adb shell dmesg

# Check SELinux denials
adb shell cat /sys/fs/selinux/enforce
adb logcat | grep avc:
</code></pre>
<h3 id="runtime-issues"><a class="header" href="#runtime-issues">Runtime Issues</a></h3>
<pre><code class="language-bash"># Check system services
adb shell dumpsys

# Specific service
adb shell dumpsys activity
adb shell dumpsys package

# Check crashes
adb shell cat /data/tombstones/tombstone_*

# Memory info
adb shell dumpsys meminfo
</code></pre>
<h2 id="resources"><a class="header" href="#resources">Resources</a></h2>
<h3 id="official-documentation"><a class="header" href="#official-documentation">Official Documentation</a></h3>
<ul>
<li><a href="https://source.android.com/">AOSP Source</a></li>
<li><a href="https://source.android.com/docs/setup/build/building">Building Android</a></li>
<li><a href="https://source.android.com/docs/core/architecture">Platform Architecture</a></li>
<li><a href="https://source.android.com/docs/core/architecture/treble">Treble</a></li>
<li><a href="https://source.android.com/docs/security/features/selinux">SELinux</a></li>
</ul>
<h3 id="tools"><a class="header" href="#tools">Tools</a></h3>
<ul>
<li><a href="https://source.android.com/docs/setup/download#installing-repo">repo</a> - Version control</li>
<li><a href="https://source.android.com/docs/setup/build">Soong</a> - Build system</li>
<li><a href="https://android-review.googlesource.com/">Gerrit</a> - Code review</li>
</ul>
<h3 id="related-documentation"><a class="header" href="#related-documentation">Related Documentation</a></h3>
<ul>
<li><a href="internals.html">Android Internals</a> - System architecture</li>
<li><a href="adb.html">ADB Commands</a> - Debug bridge reference</li>
<li><a href="binder.html">Binder IPC</a> - Inter-process communication</li>
</ul>
<h2 id="quick-reference"><a class="header" href="#quick-reference">Quick Reference</a></h2>
<h3 id="essential-commands"><a class="header" href="#essential-commands">Essential Commands</a></h3>
<pre><code class="language-bash"># Setup
repo init -u https://android.googlesource.com/platform/manifest -b master
repo sync -c -j$(nproc)
source build/envsetup.sh
lunch aosp_x86_64-eng

# Build
m -j$(nproc)                    # Full build
m [module]                      # Build module
mm                              # Build current directory
mmm path/to/module/            # Build specific path

# Flash
adb reboot bootloader
fastboot flashall -w

# Debug
adb logcat
adb shell dumpsys
adb sync

# Navigation
croot                          # Go to repo root
cgrep [pattern]               # Search C/C++ files
jgrep [pattern]               # Search Java files
</code></pre>
<h3 id="key-directories"><a class="header" href="#key-directories">Key Directories</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Path</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>frameworks/base/</code></td><td>Android framework</td></tr>
<tr><td><code>frameworks/base/services/</code></td><td>System services</td></tr>
<tr><td><code>system/core/</code></td><td>Core system components</td></tr>
<tr><td><code>packages/apps/</code></td><td>System applications</td></tr>
<tr><td><code>hardware/interfaces/</code></td><td>HAL definitions</td></tr>
<tr><td><code>device/</code></td><td>Device configurations</td></tr>
<tr><td><code>vendor/</code></td><td>Vendor-specific code</td></tr>
<tr><td><code>out/target/product/[device]/</code></td><td>Build output</td></tr>
</tbody>
</table>
</div>
<hr>
<p><strong>Last Updated</strong>: 2025-11-14</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../android/adb.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../android/jetpack.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../android/adb.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../android/jetpack.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../mark-09e88c2c.min.js"></script>
        <script src="../searcher-c2a407aa.js"></script>

        <script src="../clipboard-1626706a.min.js"></script>
        <script src="../highlight-abc7f01d.js"></script>
        <script src="../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
